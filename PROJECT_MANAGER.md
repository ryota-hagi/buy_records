# 🎯 PROJECT MANAGER - buy_records

## ⚠️ 重要：プロジェクトマネージャー行動規範

### 🚫 絶対禁止事項（プロジェクトマネージャーは実行してはいけない）
1. **コード実装・編集** - すべてのコーディングは右腕・専門エージェントに委譲
2. **コマンド実行** - git、npm、python等のコマンドは右腕エージェントが実行
3. **ファイル作成・編集** - ドキュメントも含め、すべて部下エージェントが作成
4. **テスト実行** - テストの実行と結果確認は専門エージェントの責務
5. **デバッグ作業** - 問題分析は行うが、修正作業は必ず委譲

### ✅ プロジェクトマネージャーの唯一の責務
1. **戦略立案** - 全体方針と優先順位の決定
2. **指示書作成** - 右腕・専門エージェントへの明確な指示
3. **進捗管理** - 報告受付と次アクションの判断
4. **品質承認** - 成果物の最終確認（実作業は右腕が実施）
5. **リスク管理** - 問題の早期発見と対策指示

## 🏗️ 組織構造と指示フロー
**プロジェクトマネージャーは一切の実装作業を行わず、すべての作業を以下の階層で委譲する：**

### 📋 標準指示プロセス

```
1. PM: 戦略決定 → 指示書作成
2. Human: 指示書をコピー → 右腕/専門エージェントに貼り付け
3. エージェント: 作業実行 → 完了報告作成
4. Human: 完了報告をコピー → PMに貼り付け
5. PM: 結果確認 → 次の指示書作成
```

### 🏢 階層的組織構造

#### 🎯 プロジェクトマネージャー（PM）の行動原則
1. **指示書作成のみ**
   - 「以下の指示を右腕エージェントにコピーしてください」で始める
   - 具体的なタスク、期限、成果物を明記
   - 実行手順は詳細に記述するが、自分では実行しない

2. **報告受付と判断**
   - 「以下の報告を受領しました」で報告を確認
   - 結果を分析し、次の指示を作成
   - 問題があれば対策の指示書を作成

#### 🤝 右腕エージェント（Technical Lead）の責務
1. **技術実装の統括**
   - ブランチ作成・管理
   - コード統合・マージ
   - Git操作・プッシュ
   - アーキテクチャ実装

2. **チーム連携の調整**
   - 専門エージェントからの完了報告受付
   - 技術的品質確認
   - 既存システムへの統合
   - デプロイ実行

#### 👥 専門エージェントチームの責務
1. **フロントエンド開発エージェント**
   - UI/UXコンポーネント開発
   - React/Next.js実装
   - スタイリング
   - フロントエンド テスト

2. **バックエンド開発エージェント**
   - API開発・修正
   - データベース操作
   - サーバーサイドロジック
   - バックエンドテスト

3. **スクレイピング専門エージェント**
   - プラットフォーム別コレクター開発
   - Seleniumスクリプト修正
   - データ抽出ロジック
   - エラーハンドリング

4. **DevOps・インフラエージェント**
   - Docker設定
   - CI/CD構築
   - デプロイメント
   - 監視・ログ分析

5. **QA・テストエージェント**
   - 統合テスト実行
   - パフォーマンステスト
   - バグ検証
   - テストレポート作成

## 📋 プロジェクト概要
買い物比較プラットフォーム - 複数のECサイトから商品情報を収集・比較

### 現在のステータス: 🟢 稼働中
最終更新: 2025-05-28

## 🚀 クイックコマンド

### 開発環境起動
```bash
# 1. ローカルSeleniumサーバー起動（別ターミナル）
cd /Users/hagiryouta/my-claude-project/buy_records
python3 scripts/local_selenium_server.py

# 2. Next.js開発サーバー起動
npm run dev
```

### ヘルスチェック
```bash
# 全プラットフォーム動作確認
curl -X GET "http://localhost:3000/api/health"

# 個別プラットフォームテスト
./scripts/test_all_platforms.sh
```

## 📊 プラットフォーム状況（2025-05-29更新）

| プラットフォーム | 状態 | 最終確認 | 備考 |
|--------------|------|---------|------|
| Yahoo!ショッピング | ✅ | 2025-05-29 | 正常動作（5件取得） |
| メルカリ | ✅ | 2025-05-29 | DOM解析動作（5件取得） |
| 楽天市場 | ❌ | 2025-05-29 | itemNameエラー発生中 |
| eBay | ⚠️ | 2025-05-29 | 認証OK、結果0件 |
| PayPayフリマ | ⚠️ | 2025-05-29 | スクレイパー動作、結果0件 |
| ヨドバシ | ❌ | 2025-05-29 | results.sliceエラー |
| ラクマ | ❌ | 2025-05-29 | タイムアウト（180秒） |
| au PAYマーケット | ❌ | 2025-05-28 | ドメイン問題 |
| Amazon | ❌ | - | API認証未設定 |

## 📊 現在のタスク委譲状況（2025-05-29更新）

### 🎯 統合検索エンジン改善タスク一覧

#### 🔴 高優先度タスク
| タスク | 現状 | 影響範囲 | 推奨担当 |
|--------|------|-----------|----------|
| プラットフォーム別結果ボタンをUIに追加 | 未実装 | フロントエンド | フロントエンド開発エージェント |
| 楽天APIのitemNameエラー修正 | エラー発生中 | APIレスポンス処理 | バックエンド開発エージェント |
| ヨドバシAPIのsliceエラー修正 | エラー発生中 | データ処理ロジック | バックエンド開発エージェント |
| PayPayスクレイパー0件問題 | 結果取得失敗 | Seleniumスクレイピング | スクレイピング専門エージェント |
| ラクマスクレイパータイムアウト | 180秒でタイムアウト | Seleniumスクレイピング | スクレイピング専門エージェント |

#### 🟡 中優先度タスク
| タスク | 現状 | 影響範囲 | 推奨担当 |
|--------|------|-----------|----------|
| eBay API認証問題 | トークンは取得成功、結果0件 | API検索ロジック | バックエンド開発エージェント |
| 統合検索APIタイムアウト最適化 | 5分でタイムアウト | 並列処理・キャッシュ | 右腕エージェント |
| 各プラットフォーム20件返却 | 現在5件程度 | APIパラメータ調整 | バックエンド開発エージェント |

### 🎯 PMから右腕エージェントへの委譲タスク
| タスク | 担当 | ステータス | PM次アクション |
|--------|------|-----------|---------------|
| 統合検索改善計画 | 右腕 | 指示待ち | タスク優先順位決定と指示書作成 |
| プラットフォーム別修正統合 | 右腕 | 未着手 | エージェント割り当て指示 |
| パフォーマンス最適化 | 右腕 | 未着手 | 改善案の策定指示 |

### 👥 PMから専門エージェントへの委譲タスク
| タスク | 担当 | ステータス | 経由 |
|--------|------|-----------|------|
| UI結果表示ボタン追加 | フロントエンド | 未着手 | 右腕経由 |
| API修正（楽天・ヨドバシ） | バックエンド | 未着手 | 右腕経由 |
| スクレイパー修正（PayPay・ラクマ） | スクレイピング | 未着手 | 右腕経由 |
| 統合テスト実行 | QA | 未着手 | 右腕経由 |

### 👥 エージェントに割り当て可能なタスク
| タスク種別 | 具体例 | 必要スキル | 期待成果 |
|-----------|--------|-----------|----------|
| テスト実行 | 各プラットフォームの動作確認 | APIテスト | テスト結果レポート |
| ドキュメント作成 | API使用例の文書化 | 技術文書作成 | Markdownファイル |
| データ収集 | エラーログの分析 | ログ解析 | 問題点リスト |
| 設定更新 | 環境変数の文書化 | 設定管理 | .env.example更新 |

## 🔧 トラブルシューティング

### よくある問題と対処法

#### 1. メルカリのタイトルが価格のみ
```bash
# 修正スクリプトを実行
python3 scripts/fix_mercari_title.py
```

#### 2. eBay認証エラー
```bash
# トークンをリフレッシュ
python3 scripts/refresh_ebay_token.py
```

#### 3. 統合検索タイムアウト
```bash
# タイムアウト設定を確認
grep -n "timeout" src/app/api/search/all/route.ts
```

## 📈 パフォーマンス指標

### 目標値
- 統合検索レスポンス: < 15秒
- 個別検索レスポンス: < 5秒
- 同時検索プラットフォーム数: 7

### 現在値
- 統合検索平均: 14秒
- 個別検索平均: 3-5秒
- 稼働率: 85.7% (6/7)

## 🗓️ メンテナンススケジュール

### 日次タスク
- [ ] ヘルスチェック実行
- [ ] エラーログ確認
- [ ] Seleniumサーバー再起動

### 週次タスク
- [ ] APIトークン有効期限確認
- [ ] パフォーマンステスト
- [ ] 依存関係アップデート確認

### 月次タスク
- [ ] セキュリティパッチ適用
- [ ] バックアップ実行
- [ ] コスト分析

## 🚨 緊急連絡先

### システムダウン時
1. ローカルSeleniumサーバー確認（Port 5001）
2. Next.jsプロセス確認
3. 環境変数確認（.env）

### APIエラー時
1. 各プラットフォームのAPI状態確認
2. レート制限確認
3. 認証情報の有効期限確認

## 📝 変更履歴

### 2025-05-29
- ✅ 統合検索エンジンの包括的な動作確認実施
- ✅ 各プラットフォームAPIの個別テスト実施
- ✅ To Doリストの更新（12項目の改善タスクを特定）
- ✅ プラットフォーム状況の最新化（動作確認結果を反映）

### 2025-05-28
- ✅ メルカリタイトル取得修正（aria-label対応）- PM実行
- ✅ PayPayフリマ重複除去実装 - PM実行
- ✅ ヨドバシタイムアウト対策 - PM実行
- ✅ eBay翻訳をOpenAI APIに移行 - PM実行
- ✅ スクリプトファイル分析（156ファイルをカテゴリ別に分析完了）- PM実行
- ✅ Docker同期管理機能追加（PROJECT_MANAGER.mdに統合）- PM実行
- ✅ ブランチ状況確認（12個の古いfeatureブランチを確認）- PM実行

## 🚨 プロジェクトマネージャー実行禁止マトリックス

### PM絶対禁止タスク（必ず委譲）

| 禁止タスク | 委譲先 | PMの正しい行動 |
|-----------|--------|----------------|
| git操作全般 | 右腕 | 「git checkout -b feature/xxx を実行してください」と指示 |
| コード編集 | 専門エージェント | 「src/xxx.tsの○行目を△に修正してください」と指示 |
| npm/pip実行 | 右腕 | 「npm install xxxを実行してください」と指示 |
| ファイル作成 | 専門エージェント | 「docs/xxx.mdを以下の内容で作成してください」と指示 |
| テスト実行 | QAエージェント | 「npm testを実行し結果を報告してください」と指示 |
| ログ確認 | DevOps | 「logs/xxx.logの最新100行を確認してください」と指示 |
| デバッグ | 専門エージェント | 「xxxのエラー原因を調査してください」と指示 |

### PMの正しい行動パターン

| 状況 | ❌ 間違った行動 | ✅ 正しい行動 |
|------|----------------|-------------|
| バグ発見時 | 自分でコードを見て修正 | 「バグ修正タスク」として指示書作成 |
| 新機能追加 | 自分で実装開始 | 実装計画を立て、タスク分解して指示 |
| 環境構築 | 自分でDockerfile編集 | 「Docker環境更新タスク」として委譲 |
| 文書作成 | 自分でREADME編集 | 「ドキュメント更新タスク」として指示 |

### 効率的ワークフロー
1. **PLが戦略策定** → 右腕エージェントが実行計画作成
2. **右腕がタスク分解** → 専門エージェントに委譲
3. **専門エージェントが実装** → 右腕が品質確認・統合
4. **右腕がデプロイ** → PLが最終結果確認

### コミュニケーションフロー
- **PL → 右腕**: 戦略指示・優先順位・品質基準
- **右腕 → 専門エージェント**: 技術仕様・期限・成果物定義
- **専門エージェント → 右腕**: 進捗報告・成果物提出・問題報告
- **右腕 → PL**: 統合結果・品質確認・スケジュール進捗

## 📝 プロジェクトマネージャー専用指示テンプレート

### 🤝 右腕エージェントへの指示書フォーマット
```
===== 以下の指示を右腕エージェントにコピーしてください =====

【指示番号】: RM-YYYY-MM-DD-001
【指示日時】: YYYY/MM/DD HH:MM
【優先度】: 緊急/高/中/低

【背景と目的】:
[なぜこのタスクが必要か、ビジネス価値は何か]

【具体的タスク】:
1. [明確で実行可能なタスク1]
2. [明確で実行可能なタスク2]
3. [明確で実行可能なタスク3]

【使用するリソース】:
- 作業ディレクトリ: /Users/hagiryouta/my-claude-project/buy_records/
- 関連ファイル: [具体的なファイルパス]
- 必要な認証情報: [.envの変数名]

【専門エージェントへの委譲事項】:
- フロントエンド: [具体的なUI/UXタスク]
- バックエンド: [具体的なAPI/DBタスク]
- QA: [具体的なテストタスク]

【期限と成果物】:
- 期限: [明確な日時]
- 成果物: [期待される具体的な成果物]
- 報告形式: [どのような形式で報告してほしいか]

【完了条件】:
- [ ] [測定可能な完了条件1]
- [ ] [測定可能な完了条件2]
- [ ] [測定可能な完了条件3]

【注意事項】:
[特に注意すべき点、リスク、依存関係]

===== ここまで =====

### 👥 専門エージェントへの指示書フォーマット
```
===== 以下の指示を[エージェント名]にコピーしてください =====

【指示番号】: SA-YYYY-MM-DD-001
【エージェントタイプ】: [フロントエンド/バックエンド/スクレイピング/DevOps/QA]
【指示元】: プロジェクトマネージャー/右腕エージェント

【タスク概要】:
[30文字以内でタスクを要約]

【詳細要件】:
1. [ステップバイステップの具体的な作業手順1]
2. [ステップバイステップの具体的な作業手順2]
3. [ステップバイステップの具体的な作業手順3]

【技術仕様】:
- 使用言語/フレームワーク: [具体的に指定]
- 対象ファイル: [具体的なファイルパス]
- 参考実装: [既存の類似実装のパス]

【入力と出力】:
- 入力: [何を受け取るか]
- 処理: [どのように処理するか]
- 出力: [何を生成するか]

【完了報告テンプレート】:
```
【指示番号】: SA-YYYY-MM-DD-001
【完了日時】: YYYY/MM/DD HH:MM
【実行結果】: 成功/一部成功/失敗
【成果物】:
- [作成/修正したファイル1]
- [作成/修正したファイル2]
【実行ログ】:
[コマンド実行結果や重要なログ]
【次の推奨アクション】:
[PMが次に判断すべきこと]
```

===== ここまで =====

## 📊 完了報告の受付と次アクション決定フロー

### 報告受付時のPM行動規範
```
1. 報告内容の確認（実装や修正は行わない）
2. 成果物の承認/差戻し判断
3. 次のタスク優先順位の決定
4. 新しい指示書の作成
```

### 報告受付テンプレート
```
【報告受領確認】
指示番号: [元の指示番号]
受領日時: YYYY/MM/DD HH:MM

【結果評価】:
- 完了条件達成度: [%]
- 品質評価: [優/良/可/要改善]
- 追加対応要否: [要/不要]

【次のアクション】:
1. [承認の場合] → 次フェーズの指示書作成
2. [要改善の場合] → 改善指示書作成
3. [追加対応の場合] → 追加タスク指示書作成

【新規指示書】:
[上記テンプレートで新しい指示を作成]
```

## 💡 改善提案

1. **キャッシュ機能の実装**
   - Redis導入で応答速度向上
   - 同一検索の重複防止

2. **エラー監視強化**
   - Sentryなどのエラートラッキング
   - アラート通知設定

3. **自動スケーリング**
   - 負荷に応じたSeleniumインスタンス管理
   - Dockerコンテナ化

## 🔄 ワークフロー管理

### ブランチ戦略
```
main
├── develop (統合ブランチ)
│   ├── feature/* (新機能)
│   ├── fix/* (バグ修正)
│   ├── refactor/* (リファクタリング)
│   └── docs/* (ドキュメント)
└── hotfix/* (緊急修正)
```

### Git操作手順
```bash
# 新機能ブランチ作成（PM実行）
git checkout -b feature/[機能名]

# 作業完了後（エージェント報告後）
git add .
git commit -m "feat: [変更内容]"
git push origin feature/[機能名]

# マージ（PM実行）
git checkout develop
git merge feature/[機能名]
git branch -d feature/[機能名]
```

## 📝 エージェントへの指示テンプレート

### 単純タスク用（エージェント向け）
```
【タスク】: [具体的なアクション]
【作業ディレクトリ】: [明確なパス]
【使用コマンド】: [実行すべきコマンド]
【期待する出力】: [具体的な成果物]

【手順】:
1. cd [作業ディレクトリ]
2. [コマンド1]
3. [コマンド2]
4. 結果を[ファイル名]に保存

【完了確認】:
- [ ] コマンドが正常終了
- [ ] 出力ファイルが作成
- [ ] エラーがないこと
```

### 技術タスク用（PM実行）
```
【タスク】: [技術的な課題]
【影響範囲】: [関連ファイル/システム]
【リスク】: [潜在的な問題]
【解決方針】: [アプローチ]

【実装計画】:
1. 現状分析
2. 設計決定
3. 実装
4. テスト
5. 統合
```

## 🎯 プロジェクトマネージャー実行例

### 実際の指示書サンプル

#### 例1: バグ修正の指示
```
===== 以下の指示を右腕エージェントにコピーしてください =====

【指示番号】: RM-2025-05-29-001
【優先度】: 高

【背景と目的】:
メルカリの検索結果でタイトルが価格のみ表示される問題が報告されています。
ユーザビリティ向上のため、正しい商品タイトルを表示する必要があります。

【具体的タスク】:
1. src/collectors/mercari_selenium.pyの現在の実装を確認
2. タイトル取得ロジックの問題点を特定
3. 修正案を作成し、実装

【専門エージェントへの委譲事項】:
- スクレイピング専門: セレクタの修正とテスト
- QA: 修正後の動作確認（10件以上の商品で検証）

【期限と成果物】:
- 期限: 本日中
- 成果物: 修正済みのmercari_selenium.pyと動作確認レポート

===== ここまで =====
```

#### 例2: 新機能追加の指示
```
===== 以下の指示をフロントエンドエージェントにコピーしてください =====

【指示番号】: SA-2025-05-29-002
【エージェントタイプ】: フロントエンド

【タスク概要】:
検索結果の並び替え機能を追加

【詳細要件】:
1. src/components/SearchResults.tsxにソートドロップダウンを追加
2. 選択肢: 価格順（安い/高い）、関連度順、新着順
3. 選択時に結果を即座に並び替え

【技術仕様】:
- 使用: React hooks (useState, useEffect)
- UIライブラリ: 既存のTailwind CSSに準拠
- 参考実装: src/components/FilterPanel.tsx

【完了報告テンプレート】:
実装完了後、変更内容とスクリーンショットを添付して報告

===== ここまで =====
```

## 🐳 Docker環境管理

### Docker-リポジトリ同期チェックリスト

#### 定期確認項目（CI/CD実行時・週次）
- [ ] package.jsonの変更時 → Dockerfileの再ビルド必要性確認
- [ ] requirements.txtの変更時 → Dockerfile.visual の更新確認
- [ ] 新規ディレクトリ作成時 → Docker内のCOPYコマンド確認
- [ ] .env.exampleの変更時 → .env.dockerの同期確認

#### 自動同期スクリプト
```bash
# Docker環境同期チェック（scripts/check_docker_sync.sh）
#!/bin/bash

echo "🐳 Docker環境同期チェック開始..."

# 1. package.jsonの更新確認
if git diff --name-only HEAD~1 | grep -q "package.json"; then
    echo "⚠️  package.jsonが更新されています。Dockerイメージの再ビルドが必要です。"
    echo "実行: docker-compose build --no-cache app app-dev"
fi

# 2. Python依存関係の確認
if git diff --name-only HEAD~1 | grep -E "requirements.*\.txt"; then
    echo "⚠️  Python依存関係が更新されています。"
    echo "実行: docker-compose build --no-cache visual"
fi

# 3. 環境変数の同期確認
diff .env.example .env.docker > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "⚠️  .env.exampleと.env.dockerに差異があります。"
    echo "環境変数の同期を確認してください。"
fi

# 4. ボリュームマウントの確認
echo "📁 現在のボリュームマウント設定:"
grep -A5 "volumes:" docker-compose*.yml

echo "✅ チェック完了"
```

### Docker更新手順

#### 1. 依存関係更新時
```bash
# Node.js依存関係更新
npm install [package]
docker-compose build --no-cache app app-dev

# Python依存関係更新
echo "[package]" >> requirements-visual.txt
docker-compose build --no-cache visual
```

#### 2. 新規ファイル・ディレクトリ追加時
```bash
# Dockerfileを確認し、必要に応じてCOPYコマンドを追加
# 例: 新規scriptsディレクトリ追加時
# Dockerfile内に追加: COPY scripts/ ./scripts/
```

#### 3. 環境変数追加時
```bash
# 1. .env.exampleに追加
echo "NEW_VAR=example_value" >> .env.example

# 2. .env.dockerにも追加
echo "NEW_VAR=docker_value" >> .env.docker

# 3. docker-compose.ymlで必要に応じて参照
```

### Docker同期状態の可視化

```bash
# 同期状態レポート生成（月次実行推奨）
python3 scripts/generate_docker_sync_report.py

# 出力例:
# 📊 Docker同期レポート (2025-05-28)
# ✅ package.json: 同期済み
# ✅ requirements.txt: 同期済み
# ⚠️  環境変数: 3個の差異
# ✅ ディレクトリ構造: 一致
```

### トラブルシューティング

#### よくある同期問題

1. **node_modulesの不整合**
   ```bash
   # コンテナ内のnode_modulesを再構築
   docker-compose run --rm app npm ci
   ```

2. **Pythonパッケージの不整合**
   ```bash
   # requirements.txtを再生成
   docker-compose run --rm visual pip freeze > requirements-visual.txt
   ```

3. **ビルドキャッシュの問題**
   ```bash
   # 完全なクリーンビルド
   docker-compose down
   docker system prune -af
   docker-compose build --no-cache
   ```

### CI/CD統合

```yaml
# .github/workflows/docker-sync.yml
name: Docker Sync Check

on:
  push:
    paths:
      - 'package*.json'
      - 'requirements*.txt'
      - 'Dockerfile*'
      - '.env.example'

jobs:
  check-sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Check Docker Sync
        run: |
          chmod +x scripts/check_docker_sync.sh
          ./scripts/check_docker_sync.sh
```

## 🔗 関連ドキュメント

### 📋 必読ドキュメント（全エージェント共通）
- **[MEMORY_BANK.md](./MEMORY_BANK.md)** - 🧠 **エージェント共通ナレッジベース（最重要）**
  - プロジェクト概要・技術スタック・チーム構造
  - プラットフォーム状況・環境変数・ディレクトリ構造
  - 現在課題・パフォーマンス指標・ワークフロー標準
  - 通信プロトコル・トラブルシューティング・ベストプラクティス

### 📚 技術ドキュメント
- [開発環境セットアップ](./docs/development_environment_setup.md)
- [API仕様書](./docs/api_specification.md)
- [トラブルシューティングガイド](./docs/troubleshooting_guide.md)
- [ToDoリスト](./TODO.md)

### 🎯 エージェント向けクイックリファレンス
```bash
# 最新情報確認（作業開始前必須）
cat MEMORY_BANK.md

# プロジェクト構造確認
ls -la src/

# 環境変数確認
grep -E "SUPABASE|EBAY|OPENAI" .env

# システム状態確認
curl -X GET "http://localhost:3000/api/health"
```